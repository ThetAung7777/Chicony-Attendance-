<!DOCTYPE html>
<html lang="my">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chicony Attendance & Salary</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body { font-family: sans-serif; background-color: skyblue; margin: 0; padding-bottom: 20px; }
  
  /* Navbar & UI */
  .navbar { background-color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
  .menu-btn, .profile-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #333; }
  .app-title { text-align: center; margin: 0; line-height: 1.2; }
  .logo-main { font-family: 'Arial Black', Impact, sans-serif; font-size: 26px; color: #000080; letter-spacing: -0.5px; }
  .logo-tag { font-size: 12px; color: #666; font-weight: bold; letter-spacing: 0.5px;}

  /* Dropdown & Modals */
  .dropdown { position: absolute; top: 50px; background-color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border-radius: 5px; overflow: hidden; display: none; flex-direction: column; min-width: 200px; z-index: 200;}
  .dropdown.left { left: 10px; }
  .dropdown.right { right: 10px; }
  .dropdown a { padding: 12px 15px; text-decoration: none; color: #333; font-size: 14px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 8px; cursor: pointer;}
  .dropdown a:hover { background-color: #f4f7f6; }

  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 300; }
  .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; max-height: 90vh; overflow-y: auto;}
  .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #dc3545; border: none; background: none; font-weight: bold;}

  /* Login Screen */
  #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: skyblue; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  .login-box { background: white; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 80%; max-width: 300px; }
  .google-btn { background: #4285F4; color: white; border: none; padding: 12px 20px; border-radius: 5px; font-weight: bold; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; margin-top: 20px;}
  
  /* Grid & Cards */
  .container { padding: 15px; max-width: 800px; margin: auto; }
  .setup-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;}
  .setup-box label { font-size: 13px; font-weight: bold; color: #444; display: block; margin-bottom: 5px;}
  .setup-box input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 15px;}
  .full-width { grid-column: span 2; }
  .btn-generate { background-color: #007bff; color: white; border: none; padding: 12px; font-size: 15px; font-weight: bold; border-radius: 5px; cursor: pointer; margin-top: 15px; width: 100%;}
  .calendar-wrapper { width: 100%; overflow-x: auto; padding-bottom: 10px; }
  .calendar-container { min-width: 700px; } 
  .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; font-weight: bold; margin-bottom: 10px; font-size: 14px; background: white; padding: 10px 0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);}
  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
  .day-card { border: 1px solid #ddd; padding: 6px; border-radius: 6px; text-align: center; background: #fafafa; display: flex; flex-direction: column; gap: 5px; transition: 0.3s;}
  .blank-card { background: transparent; border: none; } 

  /* Colors */
  .bg-green { background-color: #198754 !important; border-color: #146c43 !important; }
  .bg-red { background-color: #dc3545 !important; border-color: #b02a37 !important; }
  .bg-pink { background-color: #c2185b !important; border-color: #ad1457 !important; }
  .bg-dark-gray { background-color: #495057 !important; border-color: #343a40 !important; }
  .bg-green .date-label, .bg-red .date-label, .bg-pink .date-label, .bg-dark-gray .date-label { color: white !important; }
  .bg-pink .double-label { color: #ffeb3b !important; } 
  .date-label { display: block; font-size: 13px; font-weight: bold; color: #007bff;}
  
  .day-card select, .day-card input { width: 100%; padding: 4px; font-size: 11px; border: 1px solid #ccc; border-radius: 4px; text-align: center; box-sizing: border-box; background-color: white; color: black;}
  .daily-info { font-size: 11px; font-weight: bold; color: #333 !important; margin-top: 3px; background: rgba(255,255,255,0.9); padding: 4px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);}
  
  /* Developer Info */
  .developer-footer { background: white; margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  .dev-name { font-weight: bold; color: #000080; font-size: 16px; margin-bottom: 5px; }
  .dev-contact { font-size: 13px; color: #555; display: flex; justify-content: center; gap: 15px; margin-top: 8px; }
  .dev-contact a { text-decoration: none; color: #007bff; font-weight: bold; }

  /* Print Styles (For Clean PDF Export) */
  #printArea { display: none; }
  @media print {
    body { background: white; padding: 0; font-family: 'Times New Roman', serif; }
    #mainApp, #loginScreen, .loading-overlay, .modal-overlay { display: none !important; }
    #printArea { display: block !important; width: 100%; }
    .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
    .print-header h2 { margin: 0 0 5px 0; color: #000; }
    .print-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px; }
    .print-table th, .print-table td { border: 1px solid #000; padding: 8px; text-align: center; color: #000; }
    .print-table th { background-color: #f2f2f2 !important; -webkit-print-color-adjust: exact; font-weight: bold; }
    .print-summary { width: 50%; border-collapse: collapse; margin-top: 10px; float: right; }
    .print-summary th, .print-summary td { border: 1px solid #000; padding: 6px; font-size: 13px; }
    .print-summary th { text-align: left; background-color: #f2f2f2 !important; -webkit-print-color-adjust: exact; }
    .print-footer { clear: both; text-align: center; margin-top: 40px; font-size: 11px; color: #555; border-top: 1px solid #ccc; padding-top: 10px; }
  }
</style>
</head>
<body>

<div id="loginScreen">
  <div class="login-box">
    <h2 style="color: #000080; margin-bottom: 5px;">CHICONY</h2>
    <p style="font-size: 12px; color: #666; margin-top: 0;">ATTENDANCE SYSTEM</p>
    <button class="google-btn" onclick="signIn()">
      Login with Google
    </button>
  </div>
</div>

<div class="loading-overlay" id="loadingSpinner" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:2000; display:none; justify-content:center; align-items:center; font-weight:bold; color:#000080;">Loading Data...</div>

<div id="printArea"></div>

<div id="mainApp" style="display: none;">
  <div class="navbar">
    <button class="menu-btn" onclick="toggleMenu('leftMenu')">â˜°</button>
    <div id="leftMenu" class="dropdown left">
      <a href="#" onclick="saveReportToDevice()">ğŸ“ Save Report (Txt)</a>
      <a href="#" onclick="exportExcel()">ğŸ“Š Export Excel (.xlsx)</a>
      <a href="#" onclick="exportPDF()">ğŸ“„ Export Clean PDF</a>
      <a href="#" id="adminPanelBtn" onclick="openAdminPanel()" style="display:none; color: #c2185b; font-weight: bold; border-top: 2px solid #eee;">ğŸ” Admin Panel (á€á€”á€ºá€‘á€™á€ºá€¸á€…á€¬á€›á€„á€ºá€¸)</a>
      <a href="#" onclick="logout()" style="color: red; border-top: 1px solid #eee;">ğŸšª Logout</a>
    </div>
    
    <h2 class="app-title">
      <span class="logo-main">Chicony</span><br>
      <span class="logo-tag">Attendance & Salary</span>
    </h2>
    
    <button class="profile-btn" onclick="toggleMenu('rightMenu')">ğŸ‘¤</button>
    <div id="rightMenu" class="dropdown right">
      <div style="padding: 10px 15px; font-size: 12px; color: #666; background: #f1f1f1;" id="userEmailDisplay"></div>
      <a href="#" onclick="openSettings()">âš™ï¸ Settings</a>
    </div>
  </div>

  <div class="container">
    <div class="calendar-wrapper" id="calendarSection">
      <div class="calendar-container">
        <div class="weekdays">
          <div style="color: #dc3545;">á€á€”á€„á€ºá€¹á€‚á€”á€½á€±</div>
          <div>á€á€”á€„á€ºá€¹á€œá€¬</div>
          <div>á€¡á€„á€ºá€¹á€‚á€«</div>
          <div>á€—á€¯á€’á€¹á€“á€Ÿá€°á€¸</div>
          <div>á€€á€¼á€¬á€á€•á€á€±á€¸</div>
          <div>á€á€±á€¬á€€á€¼á€¬</div>
          <div style="color: #007bff;">á€…á€”á€±</div>
        </div>
        <div class="calendar-grid" id="daysGrid"></div>
      </div>
    </div>

    <div style="margin-top: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
      <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #eee;"><span>á€¡á€œá€¯á€•á€ºá€†á€„á€ºá€¸á€›á€€á€º / á€”á€¬á€›á€®</span> <b id="workCount">0 á€›á€€á€º / 0 á€”á€¬á€›á€®</b></div>
      <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #eee; color: #c2185b;"><span>á€”á€¾á€…á€ºá€†á€›á€€á€º</span> <b id="doubleCount">0 á€›á€€á€º / 0 á€”á€¬á€›á€®</b></div>
      <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #eee; color: #fd7e14;"><span>OT á€†á€„á€ºá€¸á€á€±á€¬ á€›á€€á€º / á€”á€¬á€›á€®</span> <b id="otDaysCount">0 á€›á€€á€º / 0 á€”á€¬á€›á€®</b></div>
      <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #eee; color: #d35400;"><span>OT á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ (2X + á€•á€¯á€¶á€™á€¾á€”á€º)</span> <b id="otTotalCombine">0 á€”á€¬á€›á€®</b></div>
      <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #eee; color: #dc3545;"><span>á€•á€»á€€á€ºá€›á€€á€º (x)</span> <b id="absentCount">0 á€›á€€á€º</b></div>
      <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #eee; color: #6c757d;"><span>á€•á€­á€á€ºá€›á€€á€º (-)</span> <b id="holidayCount">0 á€›á€€á€º</b></div>
      <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #eee; color: #17a2b8;"><span>á€Šá€†á€­á€¯á€„á€ºá€¸ (Night Shift)</span> <b id="nightShiftDisplay">0 á€›á€€á€º</b></div>
      <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #eee; color: #17a2b8;"><span>á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€Šá€€á€¼á€±á€¸</span> <b id="nightAllowanceDisplay">0 á€˜á€á€º</b></div>
      <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #eee; color: #28a745;"><span>á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€€á€¬á€¸á€</span> <b id="transportDisplay">0 á€˜á€á€º</b></div>
      <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #eee; color: #6610f2;"><span>á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€‘á€™á€„á€ºá€¸á€–á€­á€¯á€¸</span> <b id="foodTotal">0 á€˜á€á€º</b></div>
      <div style="display:flex; justify-content:space-between; margin-top:10px; padding-top:10px; border-top:2px solid #ccc; font-size:18px; color:#dc3545;"><b>á€¡á€á€¬á€¸á€á€„á€º á€œá€…á€¬</b> <b id="grandTotal">0 á€˜á€á€º</b></div>
    </div>

    <div class="developer-footer">
      <div class="dev-name">ğŸ‘¨â€ğŸ’» Developed by THET AUNG</div>
      <div style="font-size: 12px; color: #777; margin-bottom: 5px;">Contact for Support & Updates</div>
      <div class="dev-contact">
        <a href="http://line.me/ti/p/~678777705" target="_blank">ğŸ’¬ LINE: 678777705</a>
        <a href="https://t.me/ThetAung7777" target="_blank">âœˆï¸ Telegram: @ThetAung7777</a>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="settingsModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeSettings()">Ã—</button>
    <h3 style="margin-top: 0; text-align: center; color: #333;">âš™ï¸ Settings</h3>
    
    <div class="setup-box">
      <div class="full-width"><label>á€¡á€™á€Šá€º (Name)</label><input type="text" id="empName" placeholder="á€¡á€™á€Šá€ºá€‘á€Šá€·á€ºá€•á€«" oninput="saveToFirebase()"></div>
      <div class="full-width"><label>á€á€”á€ºá€‘á€™á€ºá€¸á€”á€¶á€•á€«á€á€º (ID)</label><input type="text" id="empId" placeholder="ID á€‘á€Šá€·á€ºá€•á€«" oninput="saveToFirebase()"></div>
      <div class="full-width"><label>á€œá€¯á€•á€ºá€á€€á€ºá€…á€á€Šá€·á€ºá€œ á€›á€½á€±á€¸á€›á€”á€º</label><input type="month" id="selectedMonth" oninput="saveToFirebase()"></div>
      <div><label>á€á€…á€ºá€›á€€á€º á€œá€¯á€•á€ºá€¡á€¬á€¸á€</label><input type="number" id="dailyWage" value="400" oninput="saveToFirebase(); calculateAll()"></div>
      <div><label>OT á€€á€¼á€±á€¸ (á á€”á€¬á€›á€®)</label><input type="number" id="otRate" value="75" oninput="saveToFirebase(); calculateAll()"></div>
    </div>
    
    <div style="margin-top: 15px;">
      <label style="color: #c2185b; font-weight:bold; font-size:13px;">â˜… á€”á€¾á€…á€ºá€†á€›á€€á€º á€á€á€ºá€™á€¾á€á€ºá€›á€”á€º</label>
      <div style="margin-top: 5px; display:flex; gap:5px;">
        <input type="date" id="doubleDateInput" style="padding:8px; border:1px solid #ccc; border-radius:4px; flex:1;">
        <button onclick="addDoubleDate()" style="background:#c2185b; color:white; border:none; padding:8px 15px; border-radius:4px;">á€‘á€Šá€·á€ºá€™á€Šá€º</button>
      </div>
      <div id="doubleDatesList"></div>
    </div>
    <button class="btn-generate" onclick="generateGrid(true)">á€‡á€šá€¬á€¸ á€–á€”á€ºá€á€®á€¸á€™á€Šá€º</button>
  </div>
</div>

<div class="modal-overlay" id="adminModal">
  <div class="modal-content" style="max-width: 500px;">
    <button class="close-modal" onclick="closeAdminPanel()">Ã—</button>
    <h3 style="margin-top: 0; text-align: center; color: #000080;">ğŸ‘¨â€ğŸ’¼ á€á€”á€ºá€‘á€™á€ºá€¸á€…á€¬á€›á€„á€ºá€¸ (Admin)</h3>
    <div id="adminUserList" style="margin-top: 15px;">Fetching users...</div>
  </div>
</div>

<script type="module">
  // Redirect System á€•á€¼á€”á€ºá€á€¯á€¶á€¸á€‘á€¬á€¸á€á€Šá€º (Popup Error á€›á€¾á€„á€ºá€¸á€›á€”á€º)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithRedirect, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
  import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBtE7JKTk0HhlLSYuj-8MiEkUPw4EnsmpU",
    authDomain: "chicony-app.firebaseapp.com",
    databaseURL: "https://chicony-app-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "chicony-app",
    storageBucket: "chicony-app.firebasestorage.app",
    messagingSenderId: "769429938968",
    appId: "1:769429938968:web:aeb2228ab137f888ceb46d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;
  const ADMIN_EMAIL = "ta.mmw.13.4.2018@gmail.com";
  let appData = { settings: {}, attendance: {} };
  let doubleDates = [];
  window.appStats = {};

  // --- Auth Functions ---
  window.signIn = () => {
    signInWithRedirect(auth, provider); // Redirect is safer for mobile Github Pages
  };

  window.logout = () => {
    signOut(auth).then(() => {
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainApp').style.display = 'none';
      location.reload();
    });
  };

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      document.getElementById('userEmailDisplay').innerText = user.email;
      if(user.email === ADMIN_EMAIL) document.getElementById('adminPanelBtn').style.display = 'block';
      loadFromFirebase();
    } else {
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainApp').style.display = 'none';
    }
  });

  // --- Database Functions ---
  window.saveToFirebase = () => {
    if (!currentUser) return;
    appData.settings = {
      empName: document.getElementById('empName').value, empId: document.getElementById('empId').value,
      selectedMonth: document.getElementById('selectedMonth').value, dailyWage: document.getElementById('dailyWage').value,
      otRate: document.getElementById('otRate').value, doubleDates: doubleDates
    };
    appData.attendance = {};
    const cards = document.querySelectorAll('.day-card');
    cards.forEach(card => {
      let dateKey = card.getAttribute('data-real-date');
      if (dateKey) {
        appData.attendance[dateKey] = {
          shift: card.querySelector('.shift-select').value, status: card.querySelector('.status-select').value,
          ot: card.querySelector('.ot-select').value, otHours: card.querySelector('.ot-hours').value
        };
      }
    });
    set(ref(db, 'users/' + currentUser.uid), appData);
  };

  function loadFromFirebase() {
    document.getElementById('loadingSpinner').style.display = 'flex';
    onValue(ref(db, 'users/' + currentUser.uid), (snapshot) => {
      document.getElementById('loadingSpinner').style.display = 'none';
      const data = snapshot.val();
      if (data) {
        appData = data;
        if(appData.settings) {
          document.getElementById('empName').value = appData.settings.empName || "";
          document.getElementById('empId').value = appData.settings.empId || "";
          document.getElementById('selectedMonth').value = appData.settings.selectedMonth || "";
          document.getElementById('dailyWage').value = appData.settings.dailyWage || 400;
          document.getElementById('otRate').value = appData.settings.otRate || 75;
          doubleDates = appData.settings.doubleDates || [];
          renderDoubleDates();
          if(appData.settings.selectedMonth) window.generateGrid(false);
        }
      } else {
        let d = new Date(); document.getElementById('selectedMonth').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      }
    }, { onlyOnce: true });
  }

  window.openAdminPanel = () => { /* Admin logic same as before */ };
  window.closeAdminPanel = () => document.getElementById('adminModal').style.display = 'none';

  // --- Global Logic ---
  const myanmarDays = ["á€á€”á€„á€ºá€¹á€‚á€”á€½á€±", "á€á€”á€„á€ºá€¹á€œá€¬", "á€¡á€„á€ºá€¹á€‚á€«", "á€—á€¯á€’á€¹á€“á€Ÿá€°á€¸", "á€€á€¼á€¬á€á€•á€á€±á€¸", "á€á€±á€¬á€€á€¼á€¬", "á€…á€”á€±"];
  window.toggleMenu = (id) => { document.getElementById('leftMenu').style.display='none'; document.getElementById('rightMenu').style.display='none'; if(id) document.getElementById(id).style.display='flex'; };
  window.openSettings = () => { document.getElementById('settingsModal').style.display = 'flex'; toggleMenu(null); };
  window.closeSettings = () => { document.getElementById('settingsModal').style.display = 'none'; };

  window.addDoubleDate = () => {
    let d = document.getElementById('doubleDateInput').value;
    if(d && !doubleDates.includes(d)) { doubleDates.push(d); renderDoubleDates(); saveToFirebase(); if(document.getElementById('selectedMonth').value) generateGrid(true); }
  };
  window.removeDoubleDate = (v) => { doubleDates = doubleDates.filter(d => d !== v); renderDoubleDates(); saveToFirebase(); if(document.getElementById('selectedMonth').value) generateGrid(true); };
  function renderDoubleDates() {
    document.getElementById('doubleDatesList').innerHTML = doubleDates.map(d => `<span class="badge">${d} <b onclick="removeDoubleDate('${d}')" style="cursor:pointer">Ã—</b></span>`).join('');
  }

  window.toggleOTInput = (el) => {
    let input = el.parentElement.querySelector('.ot-hours');
    if(el.value === 'yes') input.style.display = 'block'; else { input.style.display = 'none'; input.value = ''; }
    calculateAll();
  };

  window.generateGrid = (isNew = true) => {
    const mVal = document.getElementById('selectedMonth').value;
    if (!mVal) return; closeSettings(); 
    let [y, m] = mVal.split('-');
    let startD = new Date(y, parseInt(m) - 1, 21), endD = new Date(y, parseInt(m), 20);
    const grid = document.getElementById('daysGrid'); grid.innerHTML = ''; 
    
    for(let i=0; i < startD.getDay(); i++) grid.innerHTML += `<div class="blank-card"></div>`;
    
    let cur = new Date(startD);
    while (cur <= endD) {
      let key = `${cur.getFullYear()}-${String(cur.getMonth() + 1).padStart(2, '0')}-${String(cur.getDate()).padStart(2, '0')}`;
      let isDouble = doubleDates.includes(key), isSun = cur.getDay() === 0;
      let displayDate = `${cur.getDate()} ${cur.toLocaleString('en-US',{month:'short'})}`;
      let exportDate = `${cur.getDate()} ${cur.toLocaleString('en-US',{month:'short'})} (${myanmarDays[cur.getDay()]})`;

      let div = document.createElement('div'); div.className = 'day-card';
      div.setAttribute('data-date', exportDate); div.setAttribute('data-real-date', key); 
      div.innerHTML = `
        <label class="date-label">${displayDate}</label>
        ${isDouble ? `<div class="double-label" style="font-size: 10px; color: #c2185b; font-weight: bold; margin-bottom: 2px;">â˜… á€”á€¾á€…á€ºá€†á€›á€€á€º</div>` : `<div style="height: 10px;"></div>`}
        <input type="hidden" class="is-double" value="${isDouble}">
        <select class="shift-select" onchange="calculateAll()" style="background:#e9ecef;"><option value="day">â˜€ï¸ á€”á€±á€·á€†á€­á€¯á€„á€ºá€¸</option><option value="night">ğŸŒ™ á€Šá€†á€­á€¯á€„á€ºá€¸</option></select>
        <select class="status-select" onchange="calculateAll()">
          <option value="" ${!isSun ? 'selected' : ''}>á€›á€½á€±á€¸á€›á€”á€º...</option>
          <option value="âœ“">âœ“ á€†á€„á€ºá€¸á€á€Šá€º</option><option value="x">x á€•á€»á€€á€ºá€›á€€á€º</option>
          <option value="-" ${isSun ? 'selected' : ''}>- á€•á€­á€á€ºá€›á€€á€º</option>
        </select>
        <select class="ot-select" onchange="toggleOTInput(this)"><option value="no">OT á€™á€†á€„á€ºá€¸</option><option value="yes">OT á€†á€„á€ºá€¸</option></select>
        <input type="number" class="ot-hours" placeholder="á€”á€¬á€›á€®" oninput="calculateAll()" style="display: none;" min="0" step="0.5">
        <div class="daily-info">-</div>`;
      grid.appendChild(div); cur.setDate(cur.getDate() + 1);
    }
    
    if (!isNew && appData.attendance) {
      document.querySelectorAll('.day-card').forEach(card => {
        let d = appData.attendance[card.getAttribute('data-real-date')];
        if (d) {
          card.querySelector('.shift-select').value = d.shift || 'day';
          card.querySelector('.status-select').value = d.status || '';
          card.querySelector('.ot-select').value = d.ot || 'no';
          let otInput = card.querySelector('.ot-hours'); otInput.value = d.otHours || '';
          if(d.ot === 'yes') otInput.style.display = 'block';
        }
      });
    }
    calculateAll(); 
  };

  window.calculateAll = () => {
    const wage = parseFloat(document.getElementById('dailyWage').value) || 0;
    const rate = parseFloat(document.getElementById('otRate').value) || 0;
    let work=0, double=0, absent=0, holiday=0, night=0, otHrs=0, otDays=0, total=0, transport=0, food=0, nightPay=0;

    document.querySelectorAll('.day-card').forEach(c => {
      let isDouble = c.querySelector('.is-double').value === 'true';
      let shift = c.querySelector('.shift-select').value, status = c.querySelector('.status-select').value;
      let otStatus = c.querySelector('.ot-select').value, otVal = parseFloat(c.querySelector('.ot-hours').value) || 0;
      let info = c.querySelector('.daily-info');

      c.className = 'day-card'; 
      if(status === 'âœ“') c.classList.add(isDouble ? 'bg-pink' : (shift === 'night' ? 'bg-dark-gray' : 'bg-green'));
      else if(status === '-' || status === 'x') c.classList.add('bg-red');

      let dPay=0, fPay=0;
      if (status === 'âœ“') {
        work++; let bPay = isDouble ? (wage * 2) : wage; if(isDouble) double++;
        dPay += bPay + 40; transport += 40;
        if(shift === 'night') { night++; dPay += 100; nightPay += 100; }
        if(otStatus === 'yes') { fPay = 60; otHrs += otVal; if(otVal>0) otDays++; dPay += (otVal*rate); } else fPay = 30;
        dPay += fPay; food += fPay; total += dPay;
        info.innerHTML = (otVal>0) ? `${otVal}hr | ${dPay}à¸¿` : `${dPay}à¸¿`;
      } else {
        if(status === 'x') absent++; else if(status === '-') holiday++;
        info.innerHTML = "-";
      }
      c.setAttribute('data-total', dPay); c.setAttribute('data-ot', otVal);
    });

    let dOT = double * 8, grandOT = dOT + otHrs; 

    document.getElementById('workCount').innerText = `${work} á€›á€€á€º / ${work*8} á€”á€¬á€›á€®`;
    document.getElementById('doubleCount').innerText = `${double} á€›á€€á€º / ${double*8} á€”á€¬á€›á€®`;
    document.getElementById('absentCount').innerText = `${absent} á€›á€€á€º`;
    document.getElementById('holidayCount').innerText = `${holiday} á€›á€€á€º`;
    document.getElementById('otDaysCount').innerText = `${otDays} á€›á€€á€º / ${otHrs} á€”á€¬á€›á€®`;
    document.getElementById('otTotalCombine').innerText = `${dOT} + ${otHrs} = ${grandOT} á€”á€¬á€›á€®`;
    document.getElementById('nightShiftDisplay').innerText = `${night} á€›á€€á€º`;
    document.getElementById('nightAllowanceDisplay').innerText = `${nightPay.toLocaleString()} á€˜á€á€º`;
    document.getElementById('transportDisplay').innerText = `${transport.toLocaleString()} á€˜á€á€º`;
    document.getElementById('foodTotal').innerText = `${food.toLocaleString()} á€˜á€á€º`;
    document.getElementById('grandTotal').innerText = `${total.toLocaleString()} á€˜á€á€º`;

    saveToFirebase(); 
  };

  // ğŸ“„ CLEAN PDF EXPORT FUNCTION (á€…á€¬á€¸á€•á€½á€²á€‡á€šá€¬á€¸á€¡á€…á€…á€ºá€–á€¼á€„á€·á€º)
  window.exportPDF = () => {
    let name = document.getElementById('empName').value || '-';
    let empId = document.getElementById('empId').value || '-';
    let month = document.getElementById('selectedMonth').value || '-';

    // á€‡á€šá€¬á€¸á€á€±á€«á€„á€ºá€¸á€…á€‰á€º
    let html = `
      <div class="print-header">
        <h2>Chicony Salary Report</h2>
        <p><b>Name:</b> ${name} &nbsp;|&nbsp; <b>ID:</b> ${empId} &nbsp;|&nbsp; <b>Month:</b> ${month}</p>
      </div>
      <table class="print-table">
        <thead>
          <tr><th>Date</th><th>Shift</th><th>Status</th><th>OT Hours</th><th>Daily Total (Baht)</th></tr>
        </thead>
        <tbody>
    `;

    // á€›á€€á€ºá€¡á€œá€­á€¯á€€á€º á€’á€±á€á€¬á€™á€»á€¬á€¸
    document.querySelectorAll('.day-card').forEach(card => {
      let date = card.getAttribute('data-date');
      let shift = card.querySelector('.shift-select').value === 'day' ? 'Day' : 'Night';
      let status = card.querySelector('.status-select').value || "-";
      let ot = card.getAttribute('data-ot') || "0";
      let total = card.getAttribute('data-total') || "0";
      html += `<tr><td>${date}</td><td>${shift}</td><td>${status}</td><td>${ot}</td><td>${total}</td></tr>`;
    });

    // á€¡á€€á€»á€‰á€ºá€¸á€á€»á€¯á€•á€º á€¡á€•á€­á€¯á€„á€ºá€¸
    let work = document.getElementById('workCount').innerText;
    let absent = document.getElementById('absentCount').innerText;
    let otSum = document.getElementById('otTotalCombine').innerText;
    let gTotal = document.getElementById('grandTotal').innerText;

    html += `
        </tbody>
      </table>
      
      <table class="print-summary">
        <tr><th>Total Work (Days/Hrs)</th><td>${work}</td></tr>
        <tr><th>Total OT Hours</th><td>${otSum}</td></tr>
        <tr><th>Absent</th><td>${absent}</td></tr>
        <tr><th>Net Salary</th><td><b>${gTotal}</b></td></tr>
      </table>
      
      <div class="print-footer">
        Generated by Chicony Attendance System<br>
        Developed by <b>THET AUNG</b> | Line: 678777705 | Telegram: @ThetAung7777
      </div>
    `;

    // Print Area á€‘á€² á€‘á€Šá€·á€ºá€•á€¼á€®á€¸ Print á€‘á€¯á€á€ºá€á€¼á€„á€ºá€¸
    let pArea = document.getElementById('printArea');
    pArea.innerHTML = html;
    toggleMenu(null);
    window.print();
  };

  // ğŸ“Š EXCEL EXPORT (á€¡á€±á€¬á€€á€ºá€†á€¯á€¶á€¸á€á€½á€„á€º á€”á€¬á€›á€®á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸á€™á€»á€¬á€¸ á€‘á€•á€ºá€á€­á€¯á€¸á€‘á€¬á€¸á€á€Šá€º)
  window.exportExcel = () => {
    const cards = document.querySelectorAll('.day-card');
    if(cards.length === 0) { alert("á€‡á€šá€¬á€¸ á€¡á€›á€„á€ºá€–á€”á€ºá€á€®á€¸á€•á€«á‹"); return; }
    
    let excelData = [ ["Date", "Shift", "Status", "OT Hours", "Daily Total (Baht)"] ];
    
    cards.forEach(card => {
      let date = card.getAttribute('data-date');
      let shift = card.querySelector('.shift-select').value === 'day' ? 'Day' : 'Night';
      let status = card.querySelector('.status-select').value || "-";
      let ot = card.getAttribute('data-ot') || "0";
      let total = card.getAttribute('data-total') || "0";
      excelData.push([date, shift, status, ot, total]);
    });
    
    let wStr = document.getElementById('workCount').innerText;
    let dStr = document.getElementById('doubleCount').innerText;
    let otCombine = document.getElementById('otTotalCombine').innerText;
    let gTotal = document.getElementById('grandTotal').innerText;

    excelData.push([]);
    excelData.push(["", "", "", "Total Work Hours", wStr]);
    excelData.push(["", "", "", "Double Day Hours", dStr]);
    excelData.push(["", "", "", "Total OT Hours", otCombine]);
    excelData.push(["", "", "", "Grand Total", gTotal]);
    excelData.push([]);
    excelData.push(["", "", "", "Developed by", "THET AUNG (Line: 678777705)"]);
    
    let wb = XLSX.utils.book_new();
    let ws = XLSX.utils.aoa_to_sheet(excelData);
    XLSX.utils.book_append_sheet(wb, ws, "Salary_Report");
    let name = document.getElementById('empName').value || 'Employee';
    XLSX.writeFile(wb, `${name}_Salary_Report.xlsx`);
    toggleMenu(null);
  };

  // TXT Save 
  window.saveReportToDevice = () => { /* TXT Logics... */ toggleMenu(null); };

</script>
</body>
</html>